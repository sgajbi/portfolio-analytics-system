# Methodology Guide: Risk Analytics

This document details the financial methodologies and formulas used in the Risk Analytics engine. All calculations are performed on a periodic return series (daily, weekly, or monthly) generated by the `performance-calculator-engine` to ensure consistency with TWR metrics.

---

## 1. Volatility (Standard Deviation)

* **Definition**: Volatility measures the dispersion of a portfolio's returns around its average return. It is the most common measure of a portfolio's absolute risk. A higher volatility indicates a wider range of returns, implying greater risk.
* **Formula**: The system calculates the **sample standard deviation** ($\sigma$) of the periodic returns and then annualizes it.
    $$
    \sigma_{\text{annualized}} = \sigma_{\text{periodic}} \times \sqrt{k}
    $$
* **Key Parameters**:
    * `frequency`: Determines the periodicity of returns used (daily, weekly, monthly).
    * `annualization_factor` ($k$): The number of periods in a year (defaults to 252 for daily, 52 for weekly, 12 for monthly). This can be overridden.

---

## 2. Drawdown & Maximum Drawdown

* **Definition**: A drawdown is a measure of the decline from a historical peak in the portfolio's value. The **Maximum Drawdown** is the largest peak-to-trough decline over the life of an investment, expressed as a percentage. It is a key measure of downside risk.
* **Method**:
    1.  A **wealth index** ($WI$) is calculated from the periodic returns, starting at a base value (e.g., 1000). $WI_t = WI_{t-1} \times (1 + r_t)$.
    2.  A series of previous peaks ($PP$) is calculated: $PP_t = \max(WI_0, ..., WI_t)$.
    3.  The drawdown series ($DD$) is calculated as: $DD_t = \frac{WI_t - PP_t}{PP_t}$.
    4.  The Maximum Drawdown is the minimum value of the $DD_t$ series.
* **Output**: The API returns the `max_drawdown` value and, in the `details` object, the `peak_date` and `trough_date` of the largest drawdown.

---

## 3. Sharpe Ratio

* **Definition**: The Sharpe Ratio measures the portfolio's risk-adjusted return. It indicates how much excess return is received for each unit of volatility risk taken. A higher Sharpe Ratio is generally better.
* **Formula**:
    $$
    \text{Sharpe Ratio} = \frac{\text{Mean}(R_p - R_f)}{\sigma_p} \times \sqrt{k}
    $$
    Where:
    * $R_p$ is the periodic return of the portfolio.
    * $R_f$ is the periodic risk-free rate.
    * $\sigma_p$ is the standard deviation of the portfolio's excess returns ($R_p - R_f$).
    * $k$ is the annualization factor.
* **Key Parameters**:
    * `risk_free_mode` and `risk_free_annual_rate`: Determine the risk-free rate used in the calculation.

---

## 4. Sortino Ratio

* **Definition**: The Sortino Ratio is a variation of the Sharpe Ratio that only considers **downside deviation**. It differentiates harmful volatility from total overall volatility by using the standard deviation of negative returns.
* **Formula**:
    $$
    \text{Sortino Ratio} = \frac{\text{Mean}(R_p - MAR)}{\sigma_d} \times \sqrt{k}
    $$
    Where:
    * $MAR$ is the periodic Minimum Acceptable Return.
    * $\sigma_d$ is the downside deviation (the standard deviation of returns below the MAR).
* **Key Parameters**:
    * `mar_annual_rate`: The annual Minimum Acceptable Return, which is converted to a periodic rate for the calculation.

---

## 5. Benchmark-Relative Metrics

### 5.1. Beta ($\beta$)

* **Definition**: Beta measures the volatility or systematic risk of a portfolio in comparison to a benchmark. A beta of 1.0 indicates the portfolio moves in line with the benchmark. A beta > 1.0 indicates higher volatility, and < 1.0 indicates lower volatility.
* **Formula**:
    $$
    \beta = \frac{\text{Cov}(R_p, R_b)}{\text{Var}(R_b)}
    $$
* **Key Parameters**:
    * `benchmark_security_id`: The security ID of the benchmark against which beta is calculated.

### 5.2. Tracking Error

* **Definition**: Tracking Error measures the standard deviation of the "active return" (the difference between the portfolio's return and the benchmark's return). It quantifies how closely a portfolio follows its benchmark.
* **Formula**:
    $$
    \text{Tracking Error} = \text{Stdev}(R_p - R_b) \times \sqrt{k}
    $$

### 5.3. Information Ratio

* **Definition**: The Information Ratio measures a portfolio's ability to generate excess returns relative to a benchmark, adjusted for the volatility of those excess returns.
* **Formula**:
    $$
    \text{Information Ratio} = \frac{\text{Annualized Mean}(R_p - R_b)}{\text{Annualized Tracking Error}}
    $$

---

## 6. Value at Risk (VaR) & Expected Shortfall (ES)

### 6.1. Value at Risk (VaR)

* **Definition**: VaR is a statistical measure that estimates the potential loss of an investment over a specific time horizon, at a given confidence level. For example, a 1-day 99% VaR of 2.5% means there is a 1% chance the portfolio will lose more than 2.5% in a single day.
* **Methods**:
    * **`HISTORICAL`**: The VaR is the empirical quantile of the historical return distribution (e.g., the 1st percentile for 99% confidence). This method is non-parametric and relies on past data.
    * **`GAUSSIAN`**: Assumes returns are normally distributed and calculates VaR based on the mean, standard deviation, and a Z-score corresponding to the confidence level.
    * **`CORNISH_FISHER`**: A refinement of the Gaussian method that adjusts the Z-score to account for the skewness and kurtosis (non-normality) of the return distribution.
* **Key Parameters**: `var.method`, `var.confidence`, `var.horizon_days`.

### 6.2. Expected Shortfall (ES / CVaR)

* **Definition**: Also known as Conditional VaR (CVaR), ES answers the question: "If things do go bad (i.e., we exceed our VaR loss), what is the average loss we can expect?" It is the average of all losses in the tail of the distribution beyond the VaR threshold.
* **Key Parameters**: `var.include_expected_shortfall`.