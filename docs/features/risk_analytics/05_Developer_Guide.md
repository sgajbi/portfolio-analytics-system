
# Developer's Guide: Risk Analytics

## 1. Summary

This guide provides developers with the necessary steps to locally run, test, and verify the Risk Analytics feature.

---

## 2. Local Verification Workflow

This workflow demonstrates how to generate the necessary data and call the risk analytics endpoint.

### Step 1: Start the System

Ensure the entire analytics platform is running locally via Docker Compose.

```bash
# From the project root directory
docker compose up --build -d
````

Wait for all services to become healthy. You can check the status with `docker compose ps`.

### Step 2: Ingest Prerequisite Data

For the risk service to function, the database must contain a portfolio and its corresponding `portfolio_timeseries` data. Since the time series is generated by an upstream process, we must ingest the raw data that triggers its creation: transactions and market prices.

Execute the following `curl` commands in your Git Bash terminal.

```bash
# Ingest a test portfolio
curl -X 'POST' \
  'http://localhost:8000/ingest/portfolios' \
  -H 'Content-Type: application/json' \
  -d '{
  "portfolios": [{"portfolioId": "RISK_DEV_01", "baseCurrency": "USD", "openDate": "2025-01-01", "cifId": "RISK_DEV_CIF", "status": "ACTIVE", "riskExposure":"High", "investmentTimeHorizon":"Long", "portfolioType":"Discretionary", "bookingCenter":"SG"}]
}'

# Ingest an instrument for the portfolio
curl -X 'POST' \
  'http://localhost:8000/ingest/instruments' \
  -H 'Content-Type: application/json' \
  -d '{
  "instruments": [{"securityId": "RISK_SEC_01", "name": "Risk Dev Stock", "isin": "US_RISK_DEV", "instrumentCurrency": "USD", "productType": "Equity"}]
}'

# Ingest business dates to trigger valuation
curl -X 'POST' \
  'http://localhost:8000/ingest/business-dates' \
  -H 'Content-Type: application/json' \
  -d '{
  "business_dates": [{"businessDate": "2025-08-25"}, {"businessDate": "2025-08-26"}, {"businessDate": "2025-08-27"}]
}'

# Ingest a transaction and prices to generate time-series data
curl -X 'POST' \
  'http://localhost:8000/ingest/transactions' \
  -H 'Content-Type: application/json' \
  -d '{
  "transactions": [{"transaction_id": "RISK_TXN_01", "portfolio_id": "RISK_DEV_01", "security_id": "RISK_SEC_01", "transaction_date": "2025-08-25T10:00:00Z", "transaction_type": "BUY", "quantity": 100, "price": 100, "gross_transaction_amount": 10000, "trade_currency": "USD", "currency": "USD"}]
}'

curl -X 'POST' \
  'http://localhost:8000/ingest/market-prices' \
  -H 'Content-Type: application/json' \
  -d '{
  "market_prices": [
    {"securityId": "RISK_SEC_01", "priceDate": "2025-08-25", "price": 101.0, "currency": "USD"},
    {"securityId": "RISK_SEC_01", "priceDate": "2025-08-26", "price": 102.0, "currency": "USD"},
    {"securityId": "RISK_SEC_01", "priceDate": "2025-08-27", "price": 101.5, "currency": "USD"}
  ]
}'
```

After ingesting this data, **wait for approximately 60-90 seconds** for the event-driven pipeline to process the data and generate the `portfolio_timeseries` records.

### Step 3: Call the Risk API Endpoint

Once the pipeline has run, you can call the endpoint with a valid request body.

```bash
curl -X 'POST' \
  'http://localhost:8001/portfolios/RISK_DEV_01/risk' \
  -H 'Content-Type: application/json' \
  -d '{
  "scope": { "as_of_date": "2025-08-27" },
  "periods": [ { "type": "SI", "name": "Since Inception" } ],
  "metrics": [ "VOLATILITY", "DRAWDOWN" ]
}' | python -m json.tool
```

You should receive a `200 OK` response containing the calculated metrics.

-----

## 3\. Running Tests

To verify the correctness of the risk analytics logic, run the dedicated unit and integration tests.

```bash
# Ensure your virtual environment is active
source .venv/Scripts/activate

# Run all unit tests for the risk-analytics-engine
pytest tests/unit/libs/risk-analytics-engine/

# Run the integration test for the query-service endpoint
pytest tests/integration/services/query_service/test_risk_service.py
```

 